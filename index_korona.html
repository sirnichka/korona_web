<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Количество заражённых COVID-19 в мире</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v1.8.1/mapbox-gl.css" rel="stylesheet" />
    <link href="fonts/futura/stylesheet.css" rel="stylesheet" type="text/css" />
</head>
<body>

    <style>

        body {
            font-family: 'Futura New';
            margin: 0;
            padding: 0;
            background-color: #181824;
            margin: 0;
            padding: 0;
        }

        .main_head {
            font: 20px 'Futura New', Arial, Helvetica, sans-serif;
            color: #ffffff;
            width: 100%;
            height: 23%;
            position: fixed;
            text-align: center;
            top: 0px;
            background-color: rgba(1,1,1,0.5);
            overflow: auto
        }

        .source {
            font: 18px 'Futura New', Arial, Helvetica, sans-serif;
            color: #ffffff;
            position: fixed;
            width: 100%;
            text-align: left;
            bottom: 30px;
            left: 10px;
            overflow: auto
        }

        A {
            color: #ffffff; /* Цвет ссылок */
        }

            A:visited {
                color: #ffffff; /* Цвет посещенных ссылок */
            }

            A:active {
                color: #fdfc4c; /* Цвет активных ссылок */
            }

        .source_emg {
            font: 18px 'Futura New', Arial, Helvetica, sans-serif;
            color: #ffffff;
            position: fixed;
            width: 100%;
            text-align: left;
            bottom: 55px;
            left: 10px;
            overflow: auto
        }

        .table_full {
            top: 50px;
            height: 20%;
            margin-left: auto;
            margin-right: auto;
            position: relative;
        }

        .table_red {
            text-align: left;
            font: 45px 'Futura New', Arial, Helvetica, sans-serif;
            font-weight: bold;
            color: #fdfc4c;
            position: relative;
            text-align: left;
            padding: 0px 30px;
        }


        .table_pink {
            text-align: left;
            font-weight: bold;
            font: 27px 'Futura New', Arial, Helvetica, sans-serif;
            font-weight: bold;
            color: #ffffff;
            position: relative;
            text-align: left;
        }


        .table_date1 {
            margin: 0px 0px 0px;
            text-align: left;
            font: 20px 'Futura New', Arial, Helvetica, sans-serif;
            color: #ffffff;
            position: relative;
            text-align: left;
        }

        .table_date2 {
            margin: 0px 0px 0px;
            text-align: left;
            font: 20px 'Futura New', Arial, Helvetica, sans-serif;
            color: #ffffff;
            position: relative;
            text-align: left;
            padding: 0px 30px;
        }

        .popup_back {
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.8);
            font: 20px 'Futura New', Arial, Helvetica, sans-serif;
            font-weight: bold;
            color: #fdfc4c;
            text-align: left;
        }

        .mapboxgl-popup {
            max-width: 400px;
            font: 20px 'Futura New', Arial, Helvetica, sans-serif;
            text-align: left;
            color: #E0FFFF;
        }

        .mapboxgl-popup-content {
            background-color: rgba(1,1,1,0.8);
        }


        #map {
            position: absolute;
            width: 100%;
            height: 100%;
        }
    </style>



    <div id="map"></div>


    <div class="main_head">
        <h5>КОЛИЧЕСТВО ЗАРАЖЁННЫХ COVID-19 В МИРЕ</h5>
    </div>

    <table class="table_full">
        <tr>
            <th class="table_pink">--/--</th>
            <th class="table_red">--/--</th>
        </tr>
        <tr>
            <td class="table_date1">--/--</td>
            <td class="table_date2">--/--</td>
        </tr>

    </table>

    <div class="source">
        Источник данных: worldometers.info
    </div>
    <div class="source_emg">
        <a href="http://emg.tv/maps.html">Отдел телекартографии ООО «ЕМГ»</a>
    </div>

    <script>
		
		var fixName = {
		
			'USA':'United States',
			'UK':'United Kingdom',
			'S. Korea':'South Korea',
			'Czechia':'Czech Republic',
			'UAE':'United Arab Emirates',
			//{'Hong Kong':''}, //прибавить к china
			'Bosnia and Herzegovina':'Bosnia',
			//{'Taiwan':''}, //прибавить к china
			'DRC':'DR Congo',
			//{'Macao':''}, //прибавить к china
			'Congo':'Congo Republic',
			'Saint Kitts and Nevis':'St. Kitts and Nevis',
			'Cabo Verde':'Cape Verde',
			'Gambia':'The Gambia',
			'CAR':'Central African Republic',
			'St. Vincent Grenadines':'Saint Vincent and the Grenadines',
		}
		
		var expression = ['match', ['get', 'country']];
		
		var totalCasesToday = 0;
		var casesYesterday = 0
		var totalCases = 0
		
		
		var dataTotal = []
		var data = []

		fetch("https://corona.lmao.ninja/all").then(response => response.json()).then(function(answer){
			dataTotal = answer
		})
		
		fetch("https://corona.lmao.ninja/countries").then(response => response.json()).then(function(answer){
			data = answer
		})
		
setTimeout(function(){ // Delay

        mapboxgl.accessToken = 'pk.eyJ1IjoiaXJhZCIsImEiOiJjanVjdTE0YzgwaXhtNDNwZG9sNWt5eGl3In0.51FlFPCOJBznfpPRscP05A';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/irad/ck87k1rwe0xpk1inmngyd5vow',
            center: [0, 23],
            minZoom: 1,
            maxZoom: 4,
            zoom: 1.8

        });
		
		var intensy = 0.01
		var maxval = 180000 * intensy //TODO: сорт массива
		
        map.on('load', function () {  // EVENT

            map.addSource('blockooo', {
                type: 'vector',
                url: 'mapbox://irad.2f49vb6j'
            });
			
			data.forEach(function(row) {
			
				totalCasesToday = totalCasesToday + row['todayCases']
				totalCases = totalCases + row['cases']
				
				if(fixName[row['country']]){
			
					row['country']=fixName[row['country']]
			
				}
				
				if(row['cases']>=1){
					
					var red = ((row['cases'] / maxval) * 220) + 120;
					var green = ((row['cases'] / maxval) * 220) + 119;
					var blue = (row['cases'] / maxval) + 62;
					var color = 'rgba(' + red + ', ' + green + ', ' + blue + ', 1)';
					
					expression.push(row['country'], color);
				}
				else
				{
					
					expression.push(row['country'], 'rgba(1,1,1,1)');
				}
			});
			
			casesYesterday = totalCases - totalCasesToday
			
			
			document.getElementsByClassName('table_pink').item(0).textContent = casesYesterday
			document.getElementsByClassName('table_red').item(0).textContent = totalCases
			
			document.getElementsByClassName('table_date1').item(0).textContent = new Date(Date.now()-8640000).toLocaleString().split(',')[0]
			document.getElementsByClassName('table_date2').item(0).textContent = new Date(Date.now()).toLocaleString().split(',')[0]
			
			expression.push('rgba(0,0,0,0)');
		
            map.addLayer({
                'id': 'blocks_black',
                'type': 'fill',
                'source': 'blockooo',
                'source-layer': 'korona_blocks_country-743ln7',
                'paint': {
                    'fill-color': 'rgba(77,77,97,1)',
                }
            });

            map.addLayer({
                'id': 'blocks_main',
                'type': 'fill',
                'source': 'blockooo',
                'source-layer': 'korona_blocks_country-743ln7',
                'paint': {
                    'fill-color': expression,
                }
            });

            map.addLayer({
                'id': 'blocksx',
                'type': 'symbol',
                'source': 'blockooo',
                'source-layer': 'korona_blocks_country-743ln7',
                paint: {
                    "text-color": "#111111"

                }
            });

            map.setLayoutProperty('blocksx', 'text-field', [
                'format',
                ['get', 'alpha_3'],
                {
                    'font-scale': map.getZoom()*0.4,

                },

            ]);
      
            setInterval(function(){ //UPDATE LAYER
      
				map.setLayoutProperty('blocksx', 'text-field', [
					'format',
					['get', 'alpha_3'],
					{
						'font-scale': map.getZoom()*0.4,

					},

				]);
      
			}, 50);
	  
            map.setPaintProperty('blocksx', 'text-opacity', .9);

			// POPUP ->
            var popup = new mapboxgl.Popup({
                closeButton: false,
                closeOnClick: false
            });

            map.on('mousemove', 'blocks_main', function (e) {

                map.getCanvas().style.cursor = 'pointer';

                var coordinates = e.features[0].geometry.coordinates.slice();
                    description = e.features[0].properties["name"] + "&nbsp"
					description2 = '';
					
				data.forEach(function(row) {
					
					if(row['country']==e.features[0].properties['country']){
						
						description2 = row['cases']
					
					}
				
				});
					
                popup.setLngLat(e.lngLat).setHTML(description + "<div class=\"popup_back\">" + description2 + "</div>").addTo(map);

            });

            map.on('mouseleave', 'blocks_main', function () {
                map.getCanvas().style.cursor = '';
                popup.remove();
            });


        });

	}, 200);
    </script>

</body>
</html>
